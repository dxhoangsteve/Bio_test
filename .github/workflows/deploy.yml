name: Deploy BioWeb to VPS

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: bioweb

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Build
      run: dotnet build --no-restore
    
    - name: Test
      run: dotnet test --no-build --verbosity normal

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Deploy to VPS
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        password: ${{ secrets.VPS_PASSWORD }}
        script: |
          cd /root/bioweb-production

          # Clone/update source code
          if [ ! -d "source" ]; then
            git clone https://github.com/${{ github.repository }} source
          else
            cd source
            git fetch origin
            git reset --hard origin/main
            cd ..
          fi

          # Copy docker-compose file from source
          cp source/docker-compose.production.yml .
          cp source/nginx.conf . || echo "nginx.conf not found, will create"

          # Create nginx.conf if not exists
          if [ ! -f "nginx.conf" ]; then
            cat > nginx.conf << 'EOF'
          events {
              worker_connections 1024;
          }

          http {
              include /etc/nginx/mime.types;
              default_type application/octet-stream;

              upstream bioweb {
                  server bioweb:5000;
              }

              server {
                  listen 80;
                  server_name _;
                  return 301 https://$host$request_uri;
              }

              server {
                  listen 443 ssl http2;
                  server_name _;

                  ssl_certificate /etc/nginx/ssl/server.crt;
                  ssl_certificate_key /etc/nginx/ssl/server.key;
                  ssl_protocols TLSv1.2 TLSv1.3;

                  location / {
                      proxy_pass http://bioweb;
                      proxy_set_header Host $host;
                      proxy_set_header X-Real-IP $remote_addr;
                      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                      proxy_set_header X-Forwarded-Proto $scheme;
                  }
              }
          }
          EOF
          fi

          # Stop current containers
          docker-compose -f docker-compose.production.yml down || true

          # Build new image directly on VPS
          cd source
          docker build -f Dockerfile.production -t bioweb:latest .
          cd ..

          # Start with new image
          docker-compose -f docker-compose.production.yml up -d

          # Wait for containers to start
          echo "Waiting for containers to start..."
          sleep 60

          # Check container status
          echo "Container status:"
          docker-compose -f docker-compose.production.yml ps

          # Check app logs if unhealthy
          echo "App container logs:"
          docker logs bioweb-app --tail 50

          # Check if app is responding on port 5000
          echo "Testing app directly on port 5000..."
          curl -f http://localhost:5000/health || echo "âš ï¸ App not responding on port 5000"

          # Clean up old images
          docker image prune -f

          # Test HTTP redirect
          echo "Testing HTTP redirect..."
          curl -I http://103.157.204.17/ | grep -q "301\|302" || echo "âš ï¸ HTTP redirect not working"

          # Test HTTPS
          echo "Testing HTTPS..."
          curl -k -f https://103.157.204.17/ || echo "âš ï¸ HTTPS not working"

          # Test API
          echo "Testing API..."
          curl -k -f https://103.157.204.17/api/health || echo "âš ï¸ API health check failed"

          echo "âœ… Deployment completed!"
          echo "ðŸŒ Access your app at: https://103.157.204.17"
